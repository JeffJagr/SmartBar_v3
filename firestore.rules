rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    function emailLower() {
      return signedIn() && request.auth.token.email != null
        ? request.auth.token.email.toLowerCase()
        : null;
    }

    function companyDoc(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId));
    }

    function isOwner(companyId) {
      return signedIn()
        && exists(/databases/$(database)/documents/companies/$(companyId))
        && (
          (request.auth.uid in companyDoc(companyId).data.ownerIds)
          || companyDoc(companyId).data.ownerId == request.auth.uid // legacy single ownerId
          || companyDoc(companyId).data.createdBy == request.auth.uid // creation fallback
          || (isAuthMapped(companyId)
            && (role(companyId) == "owner" || role(companyId) == "manager"))
        );
    }

    function isPartner(companyId) {
      return signedIn()
        && exists(/databases/$(database)/documents/companies/$(companyId))
        && emailLower() != null
        && (emailLower() in companyDoc(companyId).data.partnerEmails);
    }

    function isAuthMapped(companyId) {
      return signedIn()
        && exists(/databases/$(database)/documents/companies/$(companyId)/authMap/$(request.auth.uid));
    }

    function role(companyId) {
      return isAuthMapped(companyId)
        ? get(/databases/$(database)/documents/companies/$(companyId)/authMap/$(request.auth.uid)).data.role
        : null;
    }

    function isManager(companyId) {
      return isOwner(companyId) || isPartner(companyId) || role(companyId) == "manager";
    }

    function canReadCompany(companyId) {
      return isOwner(companyId) || isPartner(companyId) || isAuthMapped(companyId);
    }

    /* staffPins: used to resolve companyCode -> companyId + PIN check */
    match /staffPins/{companyCode} {
      allow read: if signedIn();
      // Writes ONLY by managers of the linked companyId.
      // Requires staffPins docs to contain companyId.
      allow create, update, delete: if signedIn()
        && request.resource.data.companyId is string
        && isManager(request.resource.data.companyId);
    }

    /* users: each user can read/write only own profile */
    match /users/{uid} {
      allow get, create, update: if signedIn() && request.auth.uid == uid;
      allow list, delete: if false;
    }

    match /companies/{companyId} {

      allow get: if canReadCompany(companyId);

      // Allow list for signed in; the get rule still enforces doc-level access.
      // Ensure the app only queries with ownerIds/partnerEmails filters.
      allow list: if signedIn();

      // Create company: signed-in user
      allow create: if signedIn();

      // Update/delete company settings: managers
      allow update, delete: if isManager(companyId);

      /* authMap membership */
      match /authMap/{uid} {
        // Read own membership, managers can list
        allow get: if signedIn() && request.auth.uid == uid && canReadCompany(companyId);
        allow list: if isManager(companyId);

        // Create:
        // - managers can create any
        // - user can create their own doc with role "staff" (MVP staff join)
        allow create: if signedIn()
          && (
            isManager(companyId)
            || (request.auth.uid == uid && request.resource.data.role == "staff")
          );

        // Update:
        // - managers can update
        // - user can update own doc but cannot change role
        allow update: if signedIn()
          && (
            isManager(companyId)
            || (request.auth.uid == uid && request.resource.data.role == resource.data.role)
          );

        allow delete: if isManager(companyId);
      }

      /* Company subcollections (orders/notes/history/groups/products/etc.) */
      match /{coll}/{docId} {
        allow read: if canReadCompany(companyId);

        // Create/Update allowed for any member (staff included) â€” MVP operational.
        // Delete only managers.
        allow create, update: if canReadCompany(companyId);
        allow delete: if isManager(companyId);
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
